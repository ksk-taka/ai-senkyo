# AI選挙予測システム 開発ルール

## テスト駆動開発ルール

### 必須: 機能変更時のテスト実行

**変更前後に必ずテストを実行すること。**

```bash
# サーバー起動
npm run dev

# テスト実行（別ターミナルで）
npm test

# ポートは自動検出（3000-3003を順にチェック）
# 手動指定も可能: API_URL=http://localhost:3001 npm test
```

### 変更時のチェックリスト

1. **変更前**
   - [ ] テストを実行して現状が合格することを確認
   - [ ] 変更する機能を明確化

2. **変更中**
   - [ ] 最小限の変更に留める
   - [ ] 1つの機能変更につき1コミット

3. **変更後**
   - [ ] テストを実行して全て合格することを確認
   - [ ] ブラウザで手動確認
     - 政党別予測チャートが表示されるか
     - 地図が正しく色付けされるか
     - 政党クリックで都道府県一覧が表示されるか

### 基本機能テスト項目

| テスト項目 | 検証内容 |
|-----------|----------|
| 予測データ構造 | timestamp, nationalSummary, prefecturePredictions が存在 |
| 政党別予測 | 8政党以上の予測があり、議席範囲が0-465内 |
| 都道府県予測 | 各県のleadingParty, confidence, seatPredictionが存在 |
| 議席数の妥当性 | 東京≤30、大阪≤19、愛知≤16 |
| 高速モード | 東京・大阪・愛知の3県が必ず含まれる |

### エラー時の対応

1. JSONパースエラー → フォールバックデータが返されるか確認
2. API通信エラー → キャッシュから読み込まれるか確認
3. 空データ → デフォルト値が設定されているか確認

## コード規約

### Ollama統合

- 高速モードでは固定テンプレートを使用し、LLMの出力バリエーションを最小化
- エラー時は完全なデフォルトデータを返す（空配列禁止）
- 議席数は現実的な範囲に制限（各県の選挙区数以下）

### キャッシュ

- 全国予測: `.cache/national-prediction.json`
- 都道府県別: `.cache/prefectures/prefecture-{id}.json`
- 高速更新は全国キャッシュを優先使用

## ファイル構成

```
src/lib/ai/
├── ollama.ts          # Ollama LLM統合
├── perplexity.ts      # ニュース検索
├── integrator.ts      # 予測統合ロジック
└── __tests__/
    └── prediction.test.ts  # バリデーション関数

scripts/
└── test-prediction.ts  # テストスクリプト
```
